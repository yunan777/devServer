version: '3'

services:
  ### Nginx ############################################
  nginx:
    image: 'nginx:alpine'
    volumes:
      - './www:/var/www'
      - './config/nginx/nginx.conf:/etc/nginx/nginx.conf'
      - './config/nginx/sites-available:/etc/nginx/sites-available'
      - './config/nginx/includes:/etc/nginx/includes'
      - './log/nginx/:/var/log/nginx'

  ### PHP-FPM ############################################
  # php7.4-fpm:
  #   build: './build/php-fpm/7.4'
  #   volumes:
  #     - './www:/var/www'
  #   profiles:
  #     - php7.4

  php8.0-fpm:
    build: './build/php-fpm/8.0'
    volumes:
      - './www:/var/www'

  # php8.1-fpm:
  #   build: './build/php-fpm/8.1'
  #   volumes:
  #     - './www:/var/www'
  #   profiles:
  #     - php8.1

  ### MySQL ############################################
  mysql:
    image: 'mysql:8.0'
    volumes:
      - './database/mysql:/var/lib/mysql'
      - './config/mysql/mysql.cnf:/etc/mysql/conf.d/mysql.cnf'
    environment:
      - 'MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}'

  ### traefik ############################################
  traefik:
    image: 'traefik:2.6'
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - './config/traefik:/etc/traefik'
      - './log/traefik:/var/log/traefik'
    environment:
      - 'DEFAULT_CERT_RESOLVER=${DEFAULT_CERT_RESOLVER}'
      - 'ACME_EMAIL=${ACME_EMAIL}'
      - 'TRAEFIK_DASHBORD_DOMAIN=${TRAEFIK_DASHBORD_DOMAIN}'
      - 'PORTAINER_DOMAIN=${PORTAINER_DOMAIN}'
      - 'ADMINER_DOMAIN=${ADMINER_DOMAIN}'

  ### redis ############################################
  redis:
    image: 'redis:6.2-alpine'
    volumes:
      - './database/redis:/data'
      - './config/redis/redis.conf:/usr/local/etc/redis/redis.conf'
    command: 'redis-server /usr/local/etc/redis/redis.conf'

  ### workspace ############################################
  workspace:
    build: './build/workspace'
    volumes:
      - './www:/var/www'
    profiles:
      - workspace

  ### Portainer ############################################
  portainer:
    image: 'portainer:alpine'
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock'
      - './database/portainer:/data'
      - './config/portainer/password:/tmp/portainer_password'
    command: '--admin-password-file /tmp/portainer_password'

  ### Adminer ############################################
  adminer:
    image: 'adminer:standalone'
    environment:
      - 'ADMINER_DESIGN=pepa-linha'
